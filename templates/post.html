<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ post.title }} | JoshAtticus Blog</title>
  <link rel="stylesheet" href="/style.css">

  <!-- Open Graph / Facebook Meta Tags -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="{{ url }}">
  <meta property="og:title" content="{{ post.title }} | JoshAtticus Blog">
  <meta property="og:description" content="{{ post.summary }}">
  <meta property="og:image" content="{{ absolute_image_url }}">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ post.title }} | JoshAtticus Blog">
  <meta name="twitter:description" content="{{ post.summary }}">
  <meta name="twitter:image" content="{{ absolute_image_url }}">

  <script defer data-domain="blog.joshattic.us"
        src="https://plausible.joshattic.us/js/script.file-downloads.outbound-links.js"></script>
</head>

<body>
  <div class="reading-progress-container">
    <div class="reading-progress" id="reading-progress"></div>
  </div>

  <header>
    <h1><a href="/">JoshAtticus Blog</a></h1>

    <nav class="nav">
      <a href="/tags">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M3 2v6h6V2H3zm2 2h2v2H5V4zm8-2v6h6V2h-6zm2 2h2v2h-2V4zM3 12v6h6v-6H3zm2 2h2v2H5v-2zm13-2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-4zm0 2h4v2h-4v-2z" />
        </svg>
        Tags
      </a>
      <a href="/search">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M10 4a6 6 0 1 0 0 12 6 6 0 0 0 0-12zm-8 6a8 8 0 1 1 14.32 4.906l5.387 5.387a1 1 0 0 1-1.414 1.414l-5.387-5.387A8 8 0 0 1 2 10z" />
        </svg>
        Search
      </a>
    </nav>
  </header>

  <main>
    <article>
      <!-- Banner image with title overlay -->
      <div class="post-header">
        <img alt="{{ post.title }}" src="/{{ post.image }}" />
        <div class="title-overlay">
          <h1>{{ post.title }}</h1>
          <div class="date">{{ post.date }}</div>
        </div>
      </div>

      <!-- Main content container -->
      <div class="post-container">
        <div class="content">
          {{ post.content|safe }}

          <!-- Tags -->
          {% if post.tags %}
          <div class="tags" style="margin-top: 1.5rem;">
            {% for tag in post.tags %}
            <a href="/tags/{{ tag|lower|replace(' ', '-') }}" class="tag">{{ tag }}</a>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Share buttons -->
        <div class="share-buttons">
          <a href="https://twitter.com/intent/tweet?text={{ post.title }} by JoshAtticus&url={{ url }}" target="_blank"
            rel="noopener noreferrer" class="share-twitter">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
              </path>
            </svg>
            Post on X
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u={{ url }}&quote={{ post.title }} by JoshAtticus"
            target="_blank" rel="noopener noreferrer" class="share-facebook">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z">
              </path>
            </svg>
            Share on Facebook
          </a>
          <a href="mailto:?subject={{ post.title }}&body=Check out this blog post by JoshAtticus: {{ url }}"
            class="share-email">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z">
              </path>
            </svg>
            Share via Email
          </a>
        </div>

        <div class="comments">
          <h2>Comments</h2>
          <script src="https://utteranc.es/client.js" repo="JoshAtticus/blog" issue-term="title" label="comment-thread"
            theme="github-dark" crossorigin="anonymous" async>
            </script>
        </div>
      </div>
    </article>
  </main>
  <footer>© {{ year }} JoshAtticus</footer>

  <script>
    // Reading progress tracker
    window.addEventListener('scroll', () => {
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (scrollTop / scrollHeight) * 100;
      document.getElementById('reading-progress').style.width = scrolled + '%';
    });
  </script>

  <!-- Lightbox container -->
  <div id="lightbox" aria-hidden="true" role="dialog">
    <div class="lightbox-inner">
      <button class="lightbox-close" aria-label="Close">×</button>
      <button class="lightbox-nav lightbox-prev" aria-label="Previous">‹</button>
      <img class="lightbox-image" alt="" />
      <button class="lightbox-nav lightbox-next" aria-label="Next">›</button>
      <div class="lightbox-caption"></div>
    </div>
  </div>

  <script>
    // Enhance images: group adjacent images that are within the same paragraph into a grid
    (function () {
      const content = document.querySelector('.content');
      if (!content) return;

      // First, wrap all images that aren't already in a figure with a figure/figcaption using alt text
      Array.from(content.querySelectorAll('img')).forEach(img => {
        if (img.closest('figure')) return;
        const alt = img.getAttribute('alt');
        const figure = document.createElement('figure');
        img.parentNode.insertBefore(figure, img);
        figure.appendChild(img);
        if (alt && alt.trim()) {
          const cap = document.createElement('figcaption');
          cap.textContent = alt.trim();
          figure.appendChild(cap);
        }
      });

      // Convert <p><img>...<img></p> into a grid; leave paragraphs with a single img alone.
      content.querySelectorAll('p').forEach(p => {
        const imgs = Array.from(p.querySelectorAll(':scope > figure > img'));
        if (imgs.length >= 2) {
          const grid = document.createElement('div');
          grid.className = 'image-grid';
          // move images into the grid
          imgs.forEach(img => grid.appendChild(img.closest('figure')));
          // replace paragraph with grid
          p.replaceWith(grid);
        }
      });

      // Group consecutive paragraphs that each contain exactly one image into a flex row
  const paragraphs = Array.from(content.querySelectorAll('p'));
      let buffer = [];
      function flushRow() {
        if (buffer.length >= 2) {
          const row = document.createElement('div');
            row.className = 'image-row';
            buffer.forEach(p => {
      const fig = p.querySelector('figure');
      if (fig) row.appendChild(fig); // move figure wrapper
              p.remove();
            });
            // Insert before the first removed paragraph position
            const ref = buffer[0];
            ref.parentNode.insertBefore(row, ref);
        }
        buffer = [];
      }
      paragraphs.forEach(p => {
    const figs = p.querySelectorAll(':scope > figure');
    if (figs.length === 1 && !p.textContent.trim()) {
          buffer.push(p);
        } else {
          flushRow();
        }
      });
      flushRow();

      // After images load, classify by aspect ratio to apply sizing helpers
      function classify(img) {
        const w = img.naturalWidth;
        const h = img.naturalHeight;
        if (!w || !h) return; // not loaded yet
        const ratio = w / h;
        img.classList.add('screenshot-frame');
        if (ratio < 0.75) img.classList.add('portrait');
        if (ratio < 0.5) img.classList.add('ultra-tall');
        if (ratio > 2.2) img.classList.add('landscape-wide');
      }
  const allImgs = Array.from(content.querySelectorAll('figure > img'));
      allImgs.forEach(img => {
        if (img.complete) {
          classify(img);
        } else {
          img.addEventListener('load', () => classify(img));
        }
      });

      // Lightbox logic with per-group galleries
      const lightbox = document.getElementById('lightbox');
      const lbImg = lightbox.querySelector('.lightbox-image');
      const lbCaption = lightbox.querySelector('.lightbox-caption');
      const btnClose = lightbox.querySelector('.lightbox-close');
      const btnPrev = lightbox.querySelector('.lightbox-prev');
      const btnNext = lightbox.querySelector('.lightbox-next');

      let gallery = [];
      let index = 0;

      function openLightbox(images, startIndex) {
        gallery = images;
        index = startIndex;
        updateLightbox();
        lightbox.classList.add('open');
        document.body.classList.add('no-scroll');
        lightbox.setAttribute('aria-hidden', 'false');
      }

      function closeLightbox() {
        lightbox.classList.remove('open');
        document.body.classList.remove('no-scroll');
        lightbox.setAttribute('aria-hidden', 'true');
      }

      function updateLightbox() {
        const img = gallery[index];
        if (!img) return;
        lbImg.src = img.getAttribute('src');
        lbImg.alt = img.getAttribute('alt') || '';
        lbCaption.textContent = img.getAttribute('alt') || '';
        // enable/disable nav
        btnPrev.disabled = index <= 0;
        btnNext.disabled = index >= gallery.length - 1;
      }

      function showNext() {
        if (index < gallery.length - 1) {
          index++;
          updateLightbox();
        }
      }

      function showPrev() {
        if (index > 0) {
          index--;
          updateLightbox();
        }
      }

      // Attach click handlers to images
      // Images inside a grid form a gallery together; standalone images form a single-item gallery
      content.querySelectorAll('.image-grid').forEach(grid => {
        const imgs = Array.from(grid.querySelectorAll('img'));
        imgs.forEach((img, i) => {
          img.style.cursor = 'zoom-in';
          img.addEventListener('click', () => openLightbox(imgs, i));
        });
      });
      // Standalone images (not inside .image-grid)
  const standaloneImgs = Array.from(content.querySelectorAll('figure > img')).filter(img => !img.closest('.image-grid') && !img.closest('.image-row'));
      standaloneImgs.forEach(img => {
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', () => openLightbox([img], 0));
      });

      // Image rows also become gallery groups
  content.querySelectorAll('.image-row').forEach(row => {
        const imgs = Array.from(row.querySelectorAll('img'));
        imgs.forEach((img, i) => {
          img.style.cursor = 'zoom-in';
          img.addEventListener('click', () => openLightbox(imgs, i));
        });
      });

      // Controls
      btnClose.addEventListener('click', closeLightbox);
      btnNext.addEventListener('click', showNext);
      btnPrev.addEventListener('click', showPrev);
      lightbox.addEventListener('click', (e) => {
        // click outside image to close
        if (e.target === lightbox) closeLightbox();
      });

      // Keyboard controls
      document.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('open')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') showNext();
        if (e.key === 'ArrowLeft') showPrev();
      });
    })();
  </script>
</body>

</html>