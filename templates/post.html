<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ post.title }} | JoshAtticus Blog</title>
  <link rel="stylesheet" href="/style.css">

  <!-- Open Graph / Facebook Meta Tags -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="{{ url }}">
  <meta property="og:title" content="{{ post.title }} | JoshAtticus Blog">
  <meta property="og:description" content="{{ post.summary }}">
  <meta property="og:image" content="{{ absolute_image_url }}">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ post.title }} | JoshAtticus Blog">
  <meta name="twitter:description" content="{{ post.summary }}">
  <meta name="twitter:image" content="{{ absolute_image_url }}">

  <script defer data-domain="blog.joshattic.us"
        src="https://plausible.joshattic.us/js/script.file-downloads.outbound-links.js"></script>
</head>

<body>
  <div class="reading-progress-container">
    <div class="reading-progress" id="reading-progress"></div>
  </div>

  <header>
    <h1><a href="/">JoshAtticus Blog</a></h1>

    <nav class="nav">
      <a href="/tags">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M3 2v6h6V2H3zm2 2h2v2H5V4zm8-2v6h6V2h-6zm2 2h2v2h-2V4zM3 12v6h6v-6H3zm2 2h2v2H5v-2zm13-2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-4zm0 2h4v2h-4v-2z" />
        </svg>
        Tags
      </a>
      <a href="/search">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M10 4a6 6 0 1 0 0 12 6 6 0 0 0 0-12zm-8 6a8 8 0 1 1 14.32 4.906l5.387 5.387a1 1 0 0 1-1.414 1.414l-5.387-5.387A8 8 0 0 1 2 10z" />
        </svg>
        Search
      </a>
      <a href="#" id="account-btn" class="account-btn">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
        </svg>
        Account
      </a>
    </nav>
  </header>

  <main>
    <article>
      <!-- Banner image with title overlay -->
      <div class="post-header">
        <img alt="{{ post.title }}" src="/{{ post.image }}" />
        <div class="title-overlay">
          <h1>{{ post.title }}</h1>
          <div class="post-meta">
            <span class="date">{{ post.date }}</span>
            <span class="view-counter">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="view-icon">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
              {{ view_count }} views
            </span>
            <span class="share-counter">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="share-icon">
                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
              </svg>
              {{ shares_count }} shares
            </span>
          </div>
        </div>
      </div>

      <!-- Main content container -->
      <div class="post-container">
        <div class="content">
          {{ post.content|safe }}

          <!-- Tags -->
          {% if post.tags %}
          <div class="tags" style="margin-top: 1.5rem;">
            {% for tag in post.tags %}
            <a href="/tags/{{ tag|lower|replace(' ', '-') }}" class="tag">{{ tag }}</a>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Share buttons -->
        <div class="share-buttons">
          <a href="https://twitter.com/intent/tweet?text={{ post.title }} by JoshAtticus&url={{ url }}" target="_blank"
            rel="noopener noreferrer" class="share-twitter">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
              </path>
            </svg>
            Post on X
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u={{ url }}&quote={{ post.title }} by JoshAtticus"
            target="_blank" rel="noopener noreferrer" class="share-facebook">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z">
              </path>
            </svg>
            Share on Facebook
          </a>
          <a href="mailto:?subject={{ post.title }}&body=Check out this blog post by JoshAtticus: {{ url }}"
            class="share-email">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z">
              </path>
            </svg>
            Share via Email
          </a>
        </div>

        <div class="comments">
          <h2>Comments</h2>
          <div id="signin-banner" class="signin-banner" style="display: none;">
            <p>Sign in to leave a comment</p>
            <div class="auth-buttons" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
              <a href="/login" class="signin-btn" style="background-color: #1a73e8; text-decoration: none;">Sign In</a>
            </div>
          </div>
          <div id="comment-form" style="display: none;">
            <div class="comment-form-header">
              <div class="user-info" id="user-info"></div>
              <div id="reply-indicator" style="display: none; margin-left: auto; font-size: 0.9rem; color: #888;">
                Replying to <span id="reply-to-name"></span> 
                <button id="cancel-reply" style="background: none; border: none; color: #1a73e8; cursor: pointer; margin-left: 5px;">Cancel</button>
              </div>
            </div>
            <textarea id="comment-text" placeholder="Leave a comment..." maxlength="1500" rows="4" required></textarea>
            <div class="comment-form-footer">
              <span class="char-count" id="char-count">0 / 1500</span>
              <button id="submit-comment" class="submit-comment-btn">Post Comment</button>
            </div>
            <div id="comment-status"></div>
          </div>
          <div id="comments-list"></div>
        </div>
      </div>
    </article>
  </main>
  <footer>© {{ year }} JoshAtticus</footer>

  <script>
    // Comments system
    const postSlug = window.location.pathname.split('/').pop();
    let replyParentId = null;
    let currentUser = null;
    
    async function loadComments() {
      try {
        const response = await fetch(`/api/comments/${postSlug}`);
        const data = await response.json();
        displayComments(data.comments);
      } catch (error) {
        console.error('Error loading comments:', error);
      }
    }
    
    function displayComments(comments) {
      const container = document.getElementById('comments-list');
      container.textContent = ''; // Clear existing content safely
      
      if (comments.length === 0) {
        const noComments = document.createElement('p');
        noComments.className = 'no-comments';
        noComments.textContent = 'No comments yet. Be the first to comment!';
        container.appendChild(noComments);
        return;
      }
      
      // Organize comments by parent
      const topLevel = comments.filter(c => !c.parent_id);
      
      // Sort top-level comments by date DESC (Newest First)
      topLevel.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      const byParent = {};
      comments.forEach(c => {
        if (c.parent_id) {
          if (!byParent[c.parent_id]) byParent[c.parent_id] = [];
          byParent[c.parent_id].push(c);
        }
      });
      
      // Sort replies by date ASC (Oldest First - Chronological)
      for (const parentId in byParent) {
        byParent[parentId].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      }
      
      topLevel.forEach(comment => {
        container.appendChild(renderComment(comment, byParent));
      });
    }

    function replyTo(commentId, authorName) {
      replyParentId = commentId;
      document.getElementById('reply-indicator').style.display = 'block';
      document.getElementById('reply-to-name').textContent = authorName;
      document.getElementById('comment-text').focus();
      document.getElementById('comment-text').placeholder = `Replying to ${authorName}...`;
      document.getElementById('submit-comment').textContent = 'Post Reply';
      
      // Scroll to form
      document.getElementById('comment-form').scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('cancel-reply').addEventListener('click', () => {
      replyParentId = null;
      document.getElementById('reply-indicator').style.display = 'none';
      document.getElementById('comment-text').placeholder = 'Leave a comment...';
      document.getElementById('submit-comment').textContent = 'Post Comment';
    });

    function startEdit(comment, bodyEl) {
      const originalText = comment.comment_text;
      bodyEl.innerHTML = '';
      
      const textarea = document.createElement('textarea');
      textarea.className = 'edit-textarea';
      textarea.value = originalText;
      textarea.style.width = '100%';
      textarea.style.minHeight = '80px';
      textarea.style.marginTop = '0.5rem';
      textarea.style.padding = '0.5rem';
      textarea.style.background = '#121212';
      textarea.style.color = '#e0e0e0';
      textarea.style.border = '1px solid #444';
      textarea.style.borderRadius = '4px';
      
      const btnGroup = document.createElement('div');
      btnGroup.style.marginTop = '0.5rem';
      btnGroup.style.display = 'flex';
      btnGroup.style.gap = '0.5rem';
      
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.className = 'submit-comment-btn'; // Reuse style
      saveBtn.style.padding = '0.3rem 0.8rem';
      saveBtn.style.fontSize = '0.85rem';
      
      saveBtn.onclick = async () => {
        const newText = textarea.value.trim();
        if (!newText) return;
        
        try {
          const res = await fetch(`/api/comments/${comment.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ comment_text: newText })
          });
          if (res.ok) {
            loadComments();
          } else {
            alert('Failed to update comment');
          }
        } catch (e) {
          console.error(e);
        }
      };
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.style.background = 'none';
      cancelBtn.style.border = 'none';
      cancelBtn.style.color = '#888';
      cancelBtn.style.cursor = 'pointer';
      cancelBtn.onclick = () => loadComments();
      
      btnGroup.appendChild(saveBtn);
      btnGroup.appendChild(cancelBtn);
      
      bodyEl.appendChild(textarea);
      bodyEl.appendChild(btnGroup);
      textarea.focus();
    }

    async function deleteComment(id) {
      if (!confirm('Are you sure you want to delete this comment?')) return;
      try {
        const res = await fetch(`/api/comments/${id}`, { method: 'DELETE' });
        if (res.ok) {
          loadComments();
        } else {
          alert('Failed to delete comment');
        }
      } catch (e) {
        console.error(e);
      }
    }
    
    function renderComment(comment, byParent, depth = 0) {
      const commentDiv = document.createElement('div');
      commentDiv.className = 'comment';
      commentDiv.dataset.commentId = comment.id;
      
      // Avatar
      const avatar = document.createElement('img');
      avatar.className = 'comment-avatar';
      avatar.src = comment.picture || '/assets/default-avatar.png';
      avatar.alt = comment.author_name;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'comment-content';

      // Header
      const header = document.createElement('div');
      header.className = 'comment-header';
      
      const author = document.createElement('strong');
      author.className = 'comment-author';
      author.textContent = comment.author_name; 
      
      const date = document.createElement('span');
      date.className = 'comment-date';
      const dateObj = new Date(comment.created_at);
      date.textContent = dateObj.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      header.appendChild(author);
      header.appendChild(date);

      if (comment.edited_at) {
        const editedSpan = document.createElement('span');
        editedSpan.className = 'comment-edited';
        editedSpan.textContent = '(Edited)';
        editedSpan.title = new Date(comment.edited_at).toLocaleString();
        header.appendChild(editedSpan);
      }
      
      // Body
      const body = document.createElement('div');
      body.className = 'comment-body';
      
      // Strip newlines and limit length
      const cleanText = comment.comment_text.replace(/\n/g, ' ').trim();
      const shouldTruncate = cleanText.length > 300;
      
      if (shouldTruncate) {
        const truncated = cleanText.substring(0, 300);
        body.textContent = truncated + '... '; 
        
        const seeMore = document.createElement('button');
        seeMore.className = 'see-more-btn';
        seeMore.textContent = 'See more';
        seeMore.onclick = function() {
          body.textContent = cleanText; 
        };
        body.appendChild(seeMore);
      } else {
        body.textContent = cleanText; 
      }

      // Actions
      const actions = document.createElement('div');
      actions.className = 'comment-actions';
      
      const replyBtn = document.createElement('button');
      replyBtn.className = 'reply-btn';
      replyBtn.textContent = 'Reply';
      replyBtn.onclick = () => replyTo(comment.id, comment.author_name);
      
      actions.appendChild(replyBtn);

      if (currentUser && (String(currentUser.id) === String(comment.user_id) || currentUser.is_admin) && !comment.is_deleted) {
        const editBtn = document.createElement('button');
        editBtn.className = 'reply-btn'; // Reuse style
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => startEdit(comment, body);
        actions.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'reply-btn delete-action-btn';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteComment(comment.id);
        actions.appendChild(deleteBtn);
      }
      
      contentDiv.appendChild(header);
      contentDiv.appendChild(body);
      contentDiv.appendChild(actions);

      commentDiv.appendChild(avatar);
      commentDiv.appendChild(contentDiv);
      
      // Add replies
      if (byParent[comment.id]) {
        const repliesDiv = document.createElement('div');
        repliesDiv.className = 'comment-replies';
        
        if (depth < 1) {
          byParent[comment.id].forEach(reply => {
            repliesDiv.appendChild(renderComment(reply, byParent, depth + 1));
          });
        } else {
          const replyCount = byParent[comment.id].length;
          const showRepliesBtn = document.createElement('button');
          showRepliesBtn.className = 'show-replies-btn';
          showRepliesBtn.textContent = `Show ${replyCount} repl${replyCount === 1 ? 'y' : 'ies'}`;
          showRepliesBtn.onclick = function() {
            showRepliesBtn.remove();
            byParent[comment.id].forEach(reply => {
              repliesDiv.appendChild(renderComment(reply, byParent, depth + 1));
            });
          };
          repliesDiv.appendChild(showRepliesBtn);
        }
        contentDiv.appendChild(repliesDiv);
      }
      
      return commentDiv;
    }
    
    document.getElementById('submit-comment').addEventListener('click', async () => {
      const commentText = document.getElementById('comment-text').value.trim();
      const statusEl = document.getElementById('comment-status');
      const submitBtn = document.getElementById('submit-comment');
      const charCount = document.getElementById('char-count');
      
      if (!commentText) {
        statusEl.textContent = 'Please enter a comment.';
        statusEl.className = 'error';
        return;
      }
      
      if (commentText.length > 1500) {
        statusEl.textContent = 'Comment must be 1500 characters or less.';
        statusEl.className = 'error';
        return;
      }
      
      submitBtn.disabled = true;
      statusEl.textContent = 'Posting...';
      statusEl.className = '';
      
      try {
        const response = await fetch(`/api/comments/${postSlug}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            comment_text: commentText,
            parent_id: replyParentId
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          statusEl.textContent = 'Comment posted successfully!';
          statusEl.className = 'success';
          document.getElementById('comment-text').value = '';
          charCount.textContent = '0 / 1500';
          
          // Reset reply state
          replyParentId = null;
          document.getElementById('reply-indicator').style.display = 'none';
          document.getElementById('comment-text').placeholder = 'Leave a comment...';
          document.getElementById('submit-comment').textContent = 'Post Comment';

          setTimeout(() => {
            statusEl.textContent = '';
            loadComments();
          }, 2000);
        } else {
          statusEl.textContent = data.error || 'Failed to post comment.';
          statusEl.className = 'error';
        }
      } catch (error) {
        statusEl.textContent = 'Error posting comment. Please try again.';
        statusEl.className = 'error';
      } finally {
        submitBtn.disabled = false;
      }
    });
    
    // Character counter
    document.getElementById('comment-text').addEventListener('input', (e) => {
      const count = e.target.value.length;
      document.getElementById('char-count').textContent = `${count} / 1500`;
    });
    
    // Check authentication status
    async function checkAuthStatus() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        
        if (data.authenticated) {
          currentUser = data.user;
          document.getElementById('comment-form').style.display = 'block';
          document.getElementById('signin-banner').style.display = 'none';
          
          // Update user info in comment form
          const userInfo = document.getElementById('user-info');
          if (userInfo) {
            userInfo.innerHTML = `
              <img src="${data.user.picture || '/assets/default-avatar.png'}" alt="${data.user.name}" style="width: 24px; height: 24px; border-radius: 50%;">
              <span>${data.user.name}</span>
            `;
          }
          
          // Update account button
          const accountBtn = document.getElementById('account-btn');
          if (accountBtn) {
             accountBtn.innerHTML = `
                <img src="${data.user.picture || '/assets/default-avatar.png'}" alt="${data.user.name}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 5px;">
                ${data.user.name}
             `;
             accountBtn.href = "/logout";
             accountBtn.title = "Sign Out";
          }
          
        } else {
          document.getElementById('comment-form').style.display = 'none';
          document.getElementById('signin-banner').style.display = 'block';
          
          const accountBtn = document.getElementById('account-btn');
          if (accountBtn) {
             accountBtn.innerHTML = `
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg>
                Sign In
             `;
             accountBtn.href = "/login"; 
          }
        }
      } catch (error) {
        console.error('Error checking auth status:', error);
      }
    }
    
    checkAuthStatus();
    
    // Load comments on page load
    loadComments();
  </script>

  <script>
    // Reading progress tracker
    window.addEventListener('scroll', () => {
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (scrollTop / scrollHeight) * 100;
      document.getElementById('reading-progress').style.width = scrolled + '%';
    });
  </script>

  <!-- Lightbox container -->
  <div id="lightbox" aria-hidden="true" role="dialog">
    <div class="lightbox-inner">
      <button class="lightbox-close" aria-label="Close">×</button>
      <button class="lightbox-nav lightbox-prev" aria-label="Previous">‹</button>
      <img class="lightbox-image" alt="" />
      <button class="lightbox-nav lightbox-next" aria-label="Next">›</button>
      <div class="lightbox-caption"></div>
    </div>
  </div>

  <script>
    // Enhance images: group adjacent images that are within the same paragraph into a grid
    (function () {
      const content = document.querySelector('.content');
      if (!content) return;

      // First, wrap all images that aren't already in a figure with a figure/figcaption using alt text
      Array.from(content.querySelectorAll('img')).forEach(img => {
        if (img.closest('figure')) return;
        const alt = img.getAttribute('alt');
        const figure = document.createElement('figure');
        img.parentNode.insertBefore(figure, img);
        figure.appendChild(img);
        if (alt && alt.trim()) {
          const cap = document.createElement('figcaption');
          cap.textContent = alt.trim();
          figure.appendChild(cap);
        }
      });

      // Convert <p><img>...<img></p> into a grid; leave paragraphs with a single img alone.
      content.querySelectorAll('p').forEach(p => {
        const imgs = Array.from(p.querySelectorAll(':scope > figure > img'));
        if (imgs.length >= 2) {
          const grid = document.createElement('div');
          grid.className = 'image-grid';
          // move images into the grid
          imgs.forEach(img => grid.appendChild(img.closest('figure')));
          // replace paragraph with grid
          p.replaceWith(grid);
        }
      });

      // Group consecutive paragraphs that each contain exactly one image into a flex row
  const paragraphs = Array.from(content.querySelectorAll('p'));
      let buffer = [];
      function flushRow() {
        if (buffer.length >= 2) {
          const row = document.createElement('div');
            row.className = 'image-row';
            buffer.forEach(p => {
      const fig = p.querySelector('figure');
      if (fig) row.appendChild(fig); // move figure wrapper
              p.remove();
            });
            // Insert before the first removed paragraph position
            const ref = buffer[0];
            ref.parentNode.insertBefore(row, ref);
        }
        buffer = [];
      }
      paragraphs.forEach(p => {
    const figs = p.querySelectorAll(':scope > figure');
    if (figs.length === 1 && !p.textContent.trim()) {
          buffer.push(p);
        } else {
          flushRow();
        }
      });
      flushRow();

      // After images load, classify by aspect ratio to apply sizing helpers
      function classify(img) {
        const w = img.naturalWidth;
        const h = img.naturalHeight;
        if (!w || !h) return; // not loaded yet
        const ratio = w / h;
        img.classList.add('screenshot-frame');
        if (ratio < 0.75) img.classList.add('portrait');
        if (ratio < 0.5) img.classList.add('ultra-tall');
        if (ratio > 2.2) img.classList.add('landscape-wide');
      }
  const allImgs = Array.from(content.querySelectorAll('figure > img'));
      allImgs.forEach(img => {
        if (img.complete) {
          classify(img);
        } else {
          img.addEventListener('load', () => classify(img));
        }
      });

      // Lightbox logic with per-group galleries
      const lightbox = document.getElementById('lightbox');
      const lbImg = lightbox.querySelector('.lightbox-image');
      const lbCaption = lightbox.querySelector('.lightbox-caption');
      const btnClose = lightbox.querySelector('.lightbox-close');
      const btnPrev = lightbox.querySelector('.lightbox-prev');
      const btnNext = lightbox.querySelector('.lightbox-next');

      let gallery = [];
      let index = 0;

      function openLightbox(images, startIndex) {
        gallery = images;
        index = startIndex;
        updateLightbox();
        lightbox.classList.add('open');
        document.body.classList.add('no-scroll');
        lightbox.setAttribute('aria-hidden', 'false');
      }

      function closeLightbox() {
        lightbox.classList.remove('open');
        document.body.classList.remove('no-scroll');
        lightbox.setAttribute('aria-hidden', 'true');
      }

      function updateLightbox() {
        const img = gallery[index];
        if (!img) return;
        // Use full resolution if available, otherwise use current src
        const fullResSrc = img.dataset.fullResSrc || img.getAttribute('src');
        const originalSrc = fullResSrc.split('?')[0] + '?size=full';
        lbImg.src = originalSrc;
        lbImg.alt = img.getAttribute('alt') || '';
        lbCaption.textContent = img.getAttribute('alt') || '';
        // enable/disable nav
        btnPrev.disabled = index <= 0;
        btnNext.disabled = index >= gallery.length - 1;
      }

      function showNext() {
        if (index < gallery.length - 1) {
          index++;
          updateLightbox();
        }
      }

      function showPrev() {
        if (index > 0) {
          index--;
          updateLightbox();
        }
      }

      // Attach click handlers to images
      // Images inside a grid form a gallery together; standalone images form a single-item gallery
      content.querySelectorAll('.image-grid').forEach(grid => {
        const imgs = Array.from(grid.querySelectorAll('img'));
        imgs.forEach((img, i) => {
          img.style.cursor = 'zoom-in';
          img.addEventListener('click', () => openLightbox(imgs, i));
        });
      });
      // Standalone images (not inside .image-grid)
  const standaloneImgs = Array.from(content.querySelectorAll('figure > img')).filter(img => !img.closest('.image-grid') && !img.closest('.image-row'));
      standaloneImgs.forEach(img => {
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', () => openLightbox([img], 0));
      });

      // Image rows also become gallery groups
  content.querySelectorAll('.image-row').forEach(row => {
        const imgs = Array.from(row.querySelectorAll('img'));
        imgs.forEach((img, i) => {
          img.style.cursor = 'zoom-in';
          img.addEventListener('click', () => openLightbox(imgs, i));
        });
      });

      // Controls
      btnClose.addEventListener('click', closeLightbox);
      btnNext.addEventListener('click', showNext);
      btnPrev.addEventListener('click', showPrev);
      lightbox.addEventListener('click', (e) => {
        // click outside image to close
        if (e.target === lightbox) closeLightbox();
      });

      // Keyboard controls
      document.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('open')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') showNext();
        if (e.key === 'ArrowLeft') showPrev();
      });
    })();
  </script>
</body>

</html>